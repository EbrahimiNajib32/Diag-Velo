{% extends 'base.html.twig' %}

{% block title %}Paramétrage des diagnostics par type de lieu{% endblock %}

{% block body %}
    <div class="container mx-auto mt-8">
        <h1 class="text-2xl font-bold mb-6 text-center">Paramétrage des diagnostics par type de lieu</h1>

        <!-- Table -->
        <div class="container mx-auto mt-8">
            <div class="overflow-x-auto relative shadow-md sm:rounded-lg">
                <table class="w-full text-sm text-left text-gray-500 border-collapse border border-gray-200">
                    <thead>
                    <tr>
                        <th class="py-3 px-6 border border-gray-200">Types de diagnostics</th>
                        {% for lieu in typesLieux %}
                            <th class="py-3 px-6 border border-gray-200 text-center">{{ lieu.getNomTypeLieu }}</th>
                        {% endfor %}
                    </tr>
                    </thead>
                    <tbody>
                    {% for diagnostic in typesDiagnostics %}
                        <tr>
                            <td class="py-4 px-6 border border-gray-200">{{ diagnostic.getNomType }}</td>
                            {% for lieu in typesLieux %}
                                <td class="py-4 px-6 border border-gray-200 text-center">
                                    <label class="inline-flex items-center cursor-pointer">
                                        <input
                                                type="checkbox"
                                                id="checkbox-{{ diagnostic.getId }}-{{ lieu.getId }}"
                                                class="sr-only peer"
                                                {{ mapping[diagnostic.getId][lieu.getId] ? 'checked' : '' }}
                                                onchange="toggleStatus('{{ path('toggle_diagnostic_lieu_status', {'diagnosticId': diagnostic.getId, 'lieuId': lieu.getId}) }}', {{ diagnostic.getId }}, {{ lieu.getId }})"
                                        />
                                        <div class="w-11 h-6 bg-gray-200 rounded-full peer-checked:bg-green-600"></div>
                                    </label>
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}

                    </tbody>
                </table>
            </div>
        </div>
        <div class="mt-6 flex justify-center">
            <a href="{{ path('app_dashboard') }}" class="button-style hover:bg-green-400"><i class="bi bi-box-arrow-left text-xl"></i> Retour au tableau de bord</a>
        </div>

        <!-- Generic Message Modal -->
        <div id="message-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
                <div class="relative bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:max-w-lg sm:w-full">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                                <!-- Heroicon name: outline/exclamation -->
                                <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                                </svg>
                            </div>
                            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="message-modal-title">Message Title</h3>
                                <div class="mt-2">
                                    <p class="text-sm text-gray-500" id="message-modal-content">Your message here.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm" onclick="closeMessageModal()">OK</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showMessageModal(title, message) {
            document.getElementById('message-modal-title').textContent = title;
            document.getElementById('message-modal-content').textContent = message;
            document.getElementById('message-modal').classList.remove('hidden');
        }

        function closeMessageModal() {
            document.getElementById('message-modal').classList.add('hidden');
        }

        function toggleStatus(url, diagnosticId, lieuId) {
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
                .then(response => response.json())
                .then(data => {
                    if (data.newStatus) {
                        document.querySelector(`#checkbox-${diagnosticId}-${lieuId}`).checked = true;
                        alert('Type de diagnostic activé avec succès.');
                    } else {
                        document.querySelector(`#checkbox-${diagnosticId}-${lieuId}`).checked = false;
                        alert('Type de diagnostic désactivé.');
                    }
                })
                .catch(error => {
                    console.error('Erreur :', error);
                    alert("Une erreur s'est produite lors de la mise à jour du statut.");
                });
        }
    </script>

{% endblock %}
